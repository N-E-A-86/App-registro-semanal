<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Trabajo Remoto</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        /* Estilos básicos para el selector de mes del historial */
        .selector-mes-historial {
            margin-top: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: var(--fondo-oscuro);
            border-radius: 6px;
            display: none; /* Inicialmente oculto */
        }

        .selector-mes-historial button {
            margin: 0 5px 5px 0;
            padding: 5px 10px;
            background-color: var(--fondo-medio);
            color: var(--texto-claro);
            border: 1px solid var(--borde);
            border-radius: 4px;
            cursor: pointer;
        }

        .selector-mes-historial button:hover {
            background-color: var(--acento-oscuro);
        }

        /* Contenedor de login */
        #login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background-color: var(--fondo-medio);
            border-radius: 8px;
        }

        /* Ocultar la app principal */
        #app-container {
            display: none;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h2>Iniciar Sesión</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Correo Electrónico</label>
                <input type="email" id="email" required />
            </div>
            <div class="form-group">
                <label for="password">Contraseña</label>
                <input type="password" id="password" required />
            </div>
            <button type="submit" class="btn btn-primary">Ingresar</button>
        </form>
    </div>

    <div class="container" id="app-container">
        <header class="header">
            <h1>Dashboard de Trabajo Remoto</h1>
            <p>Registra tus horas, planifica tu semana y sigue tu progreso</p>
            <button id="logout-button" class="btn">Cerrar Sesión</button>
        </header>

        <main class="main-content">
            <!-- Sección de Registro de Horas -->
            <section class="card horas-trabajo">
                <h2>Registro de Horas</h2>
                <form id="formulario-horas">
                    <div class="form-group">
                        <label for="fecha">Fecha</label>
                        <input type="date" id="fecha" required />
                    </div>
                    <div class="form-group">
                        <label for="hora-entrada">Hora de Entrada</label>
                        <input type="time" id="hora-entrada" required />
                    </div>
                    <div class="form-group">
                        <label for="hora-salida">Hora de Salida</label>
                        <input type="time" id="hora-salida" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Registrar Horas</button>
                </form>

                <div class="resumen-horas">
                    <h3>Resumen Semanal y Mensual</h3>
                    <p>Total de horas esta semana: <span id="total-horas">0</span></p>
                    <p>Total de horas este mes: <span id="total-horas-mes">0</span></p>
                </div>

                <div class="historial-horas">
                    <h3>Historial Semanal</h3>
                    <ul id="lista-horas" class="lista-horas">
                        <li class="registro-hora"><em>Sin registros aún.</em></li>
                    </ul>
                </div>

                <!-- Selector de mes para el historial -->
                <div class="selector-mes-historial" id="selector-mes-historial">
                    <button onclick="setHistorialMes(0)">Este mes</button>
                    <button onclick="setHistorialMes(-1)">Mes anterior</button>
                    <button onclick="setHistorialMes(-2)">Hace 2 meses</button>
                </div>

                <!-- Enlace para mostrar historial mensual -->
                <div class="enlace-historial">
                    <!-- El texto se actualizará con JS -->
                    <button type="button" class="btn-link" id="boton-toggle-historial" onclick="toggleHistorialMensualConSelector()">
                        ▶ Historial Mensual
                    </button>
                </div>

                <!-- Contenedor oculto del historial mensual -->
                <div id="contenedor-historial-mensual" class="historial-mensual oculto">
                    <p>Registros del periodo seleccionado</p>
                    <ul id="lista-historial-mensual" class="lista-horas">
                        <!-- Generado dinámicamente -->
                    </ul>
                </div>
            </section>

            <!-- Sección de Plan de Acción Semanal -->
            <section class="card plan-accion">
                <h2>Plan de Acción Semanal</h2>
                <form id="formulario-plan">
                    <div class="form-group">
                        <label for="tarea">Nueva Tarea</label>
                        <input type="text" id="tarea" placeholder="Escribe una tarea..." required />
                    </div>
                    <div class="form-group">
                        <label for="prioridad">Prioridad</label>
                        <select id="prioridad">
                            <option value="baja">Baja</option>
                            <option value="media">Media</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Agregar Tarea</button>
                </form>

                <ul id="lista-tareas" class="tareas-lista">
                    <!-- Generado dinámicamente -->
                </ul>
            </section>

            <!-- Sección de Indicador de Progreso -->
            <section class="card progreso">
                <h2>Indicador de Progreso</h2>
                <div class="progreso-contenedor">
                    <svg class="progreso-circular" width="150" height="150" viewBox="0 0 150 150">
                        <circle class="fondo-circular" cx="75" cy="75" r="60" />
                        <circle class="progreso-circular-fill" cx="75" cy="75" r="60" />
                    </svg>
                    <div class="porcentaje">
                        <span id="porcentaje-progreso">0%</span>
                    </div>
                </div>
                <p>Completaste <span id="tareas-completadas">0</span> de <span id="total-tareas">0</span> tareas</p>
            </section>
        </main>

        <footer class="footer">
            <p>&copy; 2025 Registro de Trabajo Remoto. Arrua Nicolas Todos los derechos reservados.</p>
        </footer>
    </div>

    <!-- Firebase SDK: Compatibility Mode (v9+) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAOT2ZR3L0LI8oVfQPnIKzgWhU4sjlXS1o",
            authDomain: "mi-dashboard-trabajo.firebaseapp.com",
            projectId: "mi-dashboard-trabajo",
            storageBucket: "mi-dashboard-trabajo.firebasestorage.app",
            messagingSenderId: "507126195570",
            appId: "1:507126195570:web:674dacc7f66c45eb9b29eb"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Declarar currentUserId como variable global accesible por ambos scripts
        let currentUserId = null;

        // Cargar datos desde Firestore y hacer la función global
        async function cargarDatos(userId) {
            if (!userId) return;
            try {
                const doc = await db.collection('usuarios').doc(userId).get();
                if (doc.exists) {
                    const data = doc.data();
                    window.horasTrabajadas = data.horasTrabajadas || [];
                    window.tareas = data.tareas || [];
                } else {
                    window.horasTrabajadas = [];
                    window.tareas = [];
                }
                document.dispatchEvent(new Event('datosCargados'));
            } catch (e) {
                console.error("Error al cargar de Firestore:", e);
                window.horasTrabajadas = [];
                window.tareas = [];
                document.dispatchEvent(new Event('datosCargados'));
            }
        }
        window.cargarDatos = cargarDatos; // Hacerla global

        // Guardar datos en Firestore y hacer la función global
        async function guardarDatos() {
            if (!currentUserId || !window.horasTrabajadas || !window.tareas) return;
            try {
                await db.collection('usuarios').doc(currentUserId).set({
                    horasTrabajadas: window.horasTrabajadas,
                    tareas: window.tareas,
                    updatedAt: new Date()
                });
            } catch (e) {
                console.error("Error al guardar en Firestore:", e);
            }
        }
        window.guardarDatos = guardarDatos; // Hacerla global
    </script>

    <!-- Tu script principal (DEBE IR DESPUÉS DE LA CONFIGURACIÓN DE FIREBASE) -->
    <script src="script.js"></script>
    
    <script>
        // Lógica de autenticación y UI
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Usuario está logueado
                currentUserId = user.uid; // Actualiza la variable global
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                await window.cargarDatos(currentUserId); // Usa la función global
            } else {
                // Usuario no está logueado
                currentUserId = null; // Reinicia la variable global
                loginContainer.style.display = 'block';
                appContainer.style.display = 'none';
                window.horasTrabajadas = [];
                window.tareas = [];
                document.dispatchEvent(new Event('datosCargados'));
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    console.error("Error de autenticación:", error);
                    alert("Error al iniciar sesión: " + error.message);
                });
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // La función toggleHistorialMensualConSelector ahora se define y se hace global
        // en script.js, así que puedes eliminarla de aquí.
        // Si aún la necesitas aquí, asegúrate de que no haya duplicación.
        // REMOVED: window.toggleHistorialMensualConSelector = toggleHistorialMensualConSelector;
    </script>
</body>
</html>